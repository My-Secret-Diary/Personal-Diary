<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>My Secret Diary â€” Secure (Modern App)</title>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

<style>
  :root{
    --accent:#4a90e2;
    --accent-strong:#357abd;
    --muted:#6b7280;
    --bg:#f4f7fb;
    --card:#ffffff;
    --editor-bg: #fff;
  }
  [data-theme="dark"]{
    --bg:#071225;
    --card:#071022;
    --muted:#9fb4d8;
    --editor-bg: #04101a;
  }

  *{box-sizing:border-box}
  body{
    margin:0; font-family:'Quicksand',system-ui,Segoe UI,Roboto,Arial; background:var(--bg); min-height:100vh; padding:20px;
    transition: background .18s ease;
  }

  /* LOGIN (kept visually simple & slightly bigger) */
  #login {
    width:460px;
    max-width:96%;
    margin: 40px auto;
    background:var(--card);
    border-radius:14px;
    padding:28px;
    box-shadow:0 10px 40px rgba(2,6,23,0.08);
  }
  #login h1{ margin:0 0 8px; font-size:22px; text-align:center }
  #login p{ margin:0 0 12px; color:var(--muted); text-align:center }
  #passwordInput{ width:100%; padding:12px; border-radius:10px; border:1px solid #ddd; font-size:16px; }
  #loginBtn{ margin-top:14px; padding:12px; border-radius:10px; border:none; background:var(--accent); color:#fff; font-weight:600; cursor:pointer }
  #loginBtn:hover{ background:var(--accent-strong) }

  /* APP container */
  #appRoot{ display:none; width:100%; max-width:1200px; margin:0 auto; height:80vh; }
  .app { display:flex; gap:18px; height:100%; align-items:stretch; }

  /* left calendar */
  .left{ width:320px; background:linear-gradient(180deg,#fff,#f7fbff); border-radius:12px; padding:16px; box-shadow:0 8px 30px rgba(2,6,23,0.06); display:flex; flex-direction:column }
  .monthHeader{ display:flex; justify-content:space-between; align-items:center; gap:8px }
  .monthHeader h3{ margin:0; font-size:18px }
  .calendarGrid{ display:grid; grid-template-columns:repeat(7,1fr); gap:8px; margin-top:12px }
  .weekday{ font-size:12px; color:var(--muted); text-align:center }
  .dayCell{ height:46px; border-radius:8px; display:flex; align-items:center; justify-content:center; position:relative; cursor:pointer; transition:all .08s }
  .dayCell:hover{ transform:translateY(-3px) }
  .dayCell.disabled{ opacity:0.45; cursor:default }
  .dayCell.today{ box-shadow: inset 0 0 0 2px rgba(74,144,226,0.08) }
  .dayCell.selected{ background:var(--accent); color:#fff; }
  .dot{ position:absolute; bottom:6px; width:8px; height:8px; border-radius:50%; background:var(--accent-strong); display:none }
  .dayCell.hasEntry .dot{ display:block }

  /* right editor */
  .right{ flex:1; display:flex; flex-direction:column; gap:12px; padding:16px; border-radius:12px; background:linear-gradient(180deg,#ffffff,#fbfdff); box-shadow:0 8px 30px rgba(2,6,23,0.06); overflow:hidden }
  .topRow{ display:flex; justify-content:space-between; align-items:center }
  .titleWrap .title{ font-size:20px; font-weight:700 }
  .controls{ display:flex; gap:8px; align-items:center }
  .btn{ padding:8px 12px; border-radius:10px; border:none; cursor:pointer; background:var(--accent); color:#fff; font-weight:600 }
  .btn.ghost{ background:transparent; color:var(--muted); border:1px solid rgba(0,0,0,0.06) }
  .toolbar{ display:flex; gap:12px; align-items:center; padding:10px; border-radius:10px; background:rgba(10,20,40,0.03); flex-wrap:wrap }

  /* toolbar controls layout (horizontal) */
  .tool-btn{ padding:8px 12px; border-radius:8px; border:1px solid rgba(0,0,0,0.06); background:#fff; cursor:pointer; font-weight:700 }
  .tool-btn.active{ background:var(--accent); color:#fff; border-color:transparent }
  .small{ padding:8px; border-radius:8px; }

  /* editor area */
  #editor{ flex:1; padding:18px; border-radius:12px; min-height:420px; overflow:auto; border:1px solid rgba(0,0,0,0.06); background:var(--editor-bg); outline:none }
  #editor[contenteditable="true"]{ cursor:text }
  .placeholder{ color:#94a3b8 }

  .bottomRow{ display:flex; justify-content:flex-end; align-items:center; gap:12px }

  /* color palette popup */
  .palettePopup{ position:absolute; background:var(--card); padding:8px; border-radius:8px; box-shadow:0 10px 30px rgba(0,0,0,0.12); display:grid; grid-template-columns:repeat(6,24px); gap:6px; z-index:40 }
  .sw{ width:24px; height:24px; border-radius:6px; cursor:pointer; border:1px solid rgba(0,0,0,0.06) }

  /* responsive */
  @media (max-width:980px){ .app{ flex-direction:column; padding-bottom:24px } .left{ width:100% } .right{ width:100% } }

</style>
</head>
<body>

  <!-- LOGIN (kept visually the same, slightly bigger) -->
  <div id="login">
    <h1>ðŸ”’ My Secret Diary</h1>
    <p>Enter your diary password</p>
    <input id="passwordInput" type="password" placeholder="Password" />
    <button id="loginBtn">Login</button>
  </div>

  <!-- APP (hidden initially) -->
  <div id="appRoot" style="display:none;">
    <div class="app">

      <!-- LEFT: Calendar -->
      <div class="left">
        <div class="monthHeader">
          <button id="prevMonthBtn" class="tool-btn small" title="Previous month">â—€</button>
          <h3 id="monthLabel">Month</h3>
          <button id="nextMonthBtn" class="tool-btn small" title="Next month">â–¶</button>
        </div>

        <div class="calendarGrid" id="weekdayLabels">
          <div class="weekday">Sun</div><div class="weekday">Mon</div><div class="weekday">Tue</div><div class="weekday">Wed</div><div class="weekday">Thu</div><div class="weekday">Fri</div><div class="weekday">Sat</div>
        </div>

        <div class="calendarGrid" id="calendarGrid"></div>

        <div style="margin-top:12px; color:var(--muted); font-size:13px">Tip: You can edit today & past dates. Future dates are view-only.</div>
      </div>

      <!-- RIGHT: Editor -->
      <div class="right">
        <div class="topRow">
          <div class="titleWrap">
            <div class="title" id="diaryTitle">My Secret Diary</div>
            <div class="sub" id="diarySub" style="color:var(--muted)">Encrypted locally â€¢ Editable: past & today</div>
          </div>

          <div class="controls">
            <button id="themeToggle" class="btn ghost">Toggle Theme</button>
            <button id="changePassTop" class="btn">Change Password</button>
            <button id="renameTop" class="btn">Rename Diary</button>
          </div>
        </div>

        <div class="toolbar" role="toolbar" aria-label="Formatting toolbar">
          <button id="boldBtn" class="tool-btn" title="Bold (Ctrl/Cmd+B)">B</button>
          <button id="italicBtn" class="tool-btn" title="Italic (Ctrl/Cmd+I)">I</button>
          <button id="underlineBtn" class="tool-btn" title="Underline (Ctrl/Cmd+U)">U</button>
          <button id="highlightBtn" class="tool-btn" title="Highlight">Highlight</button>

          <div style="width:8px"></div>

          <label style="display:flex;align-items:center;gap:8px">
            <span style="color:var(--muted);font-size:13px">Font</span>
            <select id="fontSelect" class="small">
              <option value="Quicksand">Quicksand</option>
              <option value="Inter">Inter</option>
              <option value="Georgia">Serif</option>
              <option value="Courier New">Mono</option>
            </select>
          </label>

          <label style="display:flex;align-items:center;gap:8px">
            <span style="color:var(--muted);font-size:13px">Size</span>
            <select id="sizeSelect" class="small">
              <option value="14px">14</option>
              <option value="16px" selected>16</option>
              <option value="18px">18</option>
              <option value="20px">20</option>
            </select>
          </label>

          <div style="width:8px"></div>

          <div style="position:relative">
            <button id="textColorBtn" class="tool-btn" title="Text color">A</button>
            <div id="textColorPopup" class="palettePopup" style="display:none; top:44px;"></div>
          </div>

          <div style="position:relative">
            <button id="bgColorBtn" class="tool-btn" title="Highlight color">ðŸ–Œ</button>
            <div id="bgColorPopup" class="palettePopup" style="display:none; top:44px;"></div>
          </div>

          <div style="flex:1"></div>

          <label style="display:flex; align-items:center; gap:8px">
            <span style="color:var(--muted); font-size:13px">Page BG</span>
            <input id="pageBgColor" type="color" class="small" />
            <input id="pageBgURL" placeholder="image URL" style="min-width:220px;padding:8px;border-radius:8px;border:1px solid #e6eefc" />
            <button id="applyBgUrl" class="btn ghost">Apply</button>
          </label>
        </div>

        <div id="editor" contenteditable="true" spellcheck="true" aria-label="Diary editor"><div class="placeholder">Start writing your thoughts...</div></div>

        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div style="color:var(--muted); font-size:13px">Selected: <span id="selectedDate">â€”</span></div>
          <div style="color:var(--muted); font-size:13px" id="editMode">Editable</div>
        </div>

        <div class="bottomRow">
          <div id="statusText" style="color:var(--muted); font-size:13px"></div>
          <button id="saveBtn" class="btn">ðŸ’¾ Save</button>
        </div>
      </div>
    </div>
  </div>

<!-- Firebase JS (modular) -->
<script type="module">
/* ---------- Firebase & Crypto Setup ---------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

/* ---------- Use the firebaseConfig you provided ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyDRpLl01xtSZ7f0ZbId7zFASUJoem4L69s",
  authDomain: "my-secret-diary-9b62c.firebaseapp.com",
  projectId: "my-secret-diary-9b62c",
  storageBucket: "my-secret-diary-9b62c.firebasestorage.app",
  messagingSenderId: "139353851381",
  appId: "1:139353851381:web:3050a47540d36a2243ccbc"
};

const firebaseApp = initializeApp(firebaseConfig);
const auth = getAuth(firebaseApp);
const db = getFirestore(firebaseApp);

/* ---------- DOM refs ---------- */
const loginDiv = document.getElementById('login');
const passwordInput = document.getElementById('passwordInput');
const loginBtn = document.getElementById('loginBtn');
const appRoot = document.getElementById('appRoot');
const calendarGrid = document.getElementById('calendarGrid');
const monthLabel = document.getElementById('monthLabel');
const selectedDateSpan = document.getElementById('selectedDate');
const editModeSpan = document.getElementById('editMode');
const statusText = document.getElementById('statusText');
const editor = document.getElementById('editor');
const boldBtn = document.getElementById('boldBtn');
const italicBtn = document.getElementById('italicBtn');
const underlineBtn = document.getElementById('underlineBtn');
const highlightBtn = document.getElementById('highlightBtn');
const textColorBtn = document.getElementById('textColorBtn');
const textColorPopup = document.getElementById('textColorPopup');
const bgColorBtn = document.getElementById('bgColorBtn');
const bgColorPopup = document.getElementById('bgColorPopup');
const fontSelect = document.getElementById('fontSelect');
const sizeSelect = document.getElementById('sizeSelect');
const pageBgColor = document.getElementById('pageBgColor');
const pageBgURL = document.getElementById('pageBgURL');
const applyBgUrl = document.getElementById('applyBgUrl');
const saveBtn = document.getElementById('saveBtn');
const diaryTitleElem = document.getElementById('diaryTitle');
const themeToggle = document.getElementById('themeToggle');
const changePassTop = document.getElementById('changePassTop');
const renameTop = document.getElementById('renameTop');
const prevMonthBtn = document.getElementById('prevMonthBtn');
const nextMonthBtn = document.getElementById('nextMonthBtn');

/* ---------- State ---------- */
let uid = null;
let currentPassword = null;
let diaryName = "My Secret Diary";
let selectedDate = toYMD(new Date()); // local date string yyyy-mm-dd
let calendarYear = new Date().getFullYear();
let calendarMonth = new Date().getMonth();
let entriesIndex = {}; // map date->true
let settingsMeta = { theme:'light', background:null, font:'Quicksand', size:'16px' };

/* ---------- Small helpers ---------- */
function toYMD(d){ const dt = (d instanceof Date) ? d : new Date(d); // use local date
  // create yyyy-mm-dd using local year/month/day (no timezone offset)
  const y = dt.getFullYear(); const m = String(dt.getMonth()+1).padStart(2,'0'); const day = String(dt.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}
function formatNice(d){ return new Date(d).toLocaleDateString(); }
function bufToB64(buf){ return btoa(String.fromCharCode(...new Uint8Array(buf))); }
function b64ToBuf(b64){ return Uint8Array.from(atob(b64), c=>c.charCodeAt(0)); }

/* ---------- Crypto: PBKDF2 -> AES-GCM ---------- */
async function deriveKey(password, salt) {
  const enc = new TextEncoder();
  const baseKey = await crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveKey']);
  return crypto.subtle.deriveKey({ name:'PBKDF2', salt, iterations:150000, hash:'SHA-256' }, baseKey, { name:'AES-GCM', length:256 }, false, ['encrypt','decrypt']);
}
async function encryptPayload(password, payloadObj){
  const salt = crypto.getRandomValues(new Uint8Array(16));
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const key = await deriveKey(password, salt);
  const enc = new TextEncoder();
  const data = enc.encode(JSON.stringify(payloadObj));
  const cipher = await crypto.subtle.encrypt({ name:'AES-GCM', iv }, key, data);
  return { cipher: bufToB64(cipher), iv: bufToB64(iv), salt: bufToB64(salt) };
}
async function decryptPayload(password, docData){
  const iv = b64ToBuf(docData.iv);
  const salt = b64ToBuf(docData.salt);
  const key = await deriveKey(password, salt);
  const plain = await crypto.subtle.decrypt({ name:'AES-GCM', iv }, key, b64ToBuf(docData.cipher));
  const dec = new TextDecoder();
  return JSON.parse(dec.decode(plain));
}

/* ---------- Firestore helpers (per-user paths) ---------- */
function userDocRef(parts){ // parts e.g. ['entries','2025-11-01']
  if(!uid) throw new Error('No uid');
  return doc(db, 'users', uid, ...parts);
}

/* ---------- Settings load/save ---------- */
async function loadSettings(){
  try {
    const sRef = userDocRef(['settings']);
    const snap = await getDoc(sRef);
    if(!snap.exists()){
      // create encrypted default settings
      const payload = { name: diaryName, meta: settingsMeta };
      const enc = await encryptPayload(currentPassword, payload);
      await setDoc(sRef, enc);
      diaryTitleElem.textContent = diaryName;
      applySettingsMeta();
      return;
    }
    const data = snap.data();
    // decrypt
    try {
      const payload = await decryptPayload(currentPassword, data);
      diaryName = payload.name || diaryName;
      settingsMeta = payload.meta || settingsMeta;
      diaryTitleElem.textContent = diaryName;
      applySettingsMeta();
    } catch(e){
      console.warn('Settings: decrypt failed (wrong password?)', e);
    }
  } catch(e){ console.error('loadSettings error', e) }
}

async function saveSettings(){
  try {
    const sRef = userDocRef(['settings']);
    const payload = { name: diaryName, meta: settingsMeta };
    const enc = await encryptPayload(currentPassword, payload);
    await setDoc(sRef, enc);
  } catch(e){ console.error('saveSettings error', e) }
}

/* ---------- Entry load/save ---------- */
async function loadEntry(dateKey){
  statusText.textContent = 'Loading...';
  try {
    const eRef = userDocRef(['entries', dateKey]);
    const snap = await getDoc(eRef);
    if(!snap.exists()){
      editor.innerHTML = '<div class="placeholder">Start writing your thoughts...</div>';
      statusText.textContent = 'No entry';
      return;
    }
    const data = snap.data();
    if(data.cipher && data.iv && data.salt){
      try {
        const payload = await decryptPayload(currentPassword, data);
        editor.innerHTML = payload.html || '';
        settingsMeta = payload.meta || settingsMeta;
        diaryName = payload.diaryName || diaryName;
        diaryTitleElem.textContent = diaryName;
        applySettingsMeta();
        statusText.textContent = 'Loaded (decrypted)';
      } catch(e){
        editor.innerHTML = '<div class="placeholder">Unable to decrypt this entry (wrong password)</div>';
        statusText.textContent = 'Decrypt failed';
      }
    } else if(data.text){
      // legacy plaintext
      editor.textContent = data.text || '';
      statusText.textContent = 'Loaded (legacy plaintext)';
    } else {
      editor.innerHTML = '<div class="placeholder">Empty</div>';
      statusText.textContent = 'Empty';
    }
  } catch(e){ console.error('loadEntry error', e); statusText.textContent = 'Load error' }
}

async function saveEntry(dateKey){
  const dd = new Date(dateKey + 'T00:00:00');
  const today = new Date(); today.setHours(0,0,0,0);
  if(dd > today){ alert('Cannot save future entries'); return; }
  ensurePlaceholder();
  const html = editor.innerHTML;
  const payload = { html, meta: settingsMeta, diaryName, savedAt: new Date().toISOString() };
  statusText.textContent = 'Encrypting & saving...';
  try {
    const enc = await encryptPayload(currentPassword, payload);
    await setDoc(userDocRef(['entries', dateKey]), { ...enc, savedAt: serverTimestamp() });
    entriesIndex[dateKey] = true;
    renderCalendar(calendarYear, calendarMonth);
    statusText.textContent = 'Saved (encrypted)';
    alert('Saved!');
  } catch(e){ console.error('saveEntry error', e); statusText.textContent = 'Save failed'; alert('Save failed'); }
}

/* ---------- UI related helpers ---------- */
function applySettingsMeta(){
  document.body.setAttribute('data-theme', settingsMeta.theme || 'light');
  if(settingsMeta.background){
    if(settingsMeta.background.startsWith('http')) document.body.style.backgroundImage = `url("${settingsMeta.background}")`;
    else { document.body.style.backgroundImage = ''; document.body.style.backgroundColor = settingsMeta.background; }
  } else { document.body.style.backgroundImage = ''; document.body.style.backgroundColor = ''; }
  if(settingsMeta.font) fontSelect.value = settingsMeta.font;
  if(settingsMeta.size) sizeSelect.value = settingsMeta.size;
  editor.style.fontFamily = fontSelect.value;
  editor.style.fontSize = sizeSelect.value;
}

function ensurePlaceholder(){
  if(!editor.innerText.trim()){
    editor.innerHTML = '<div class="placeholder">Start writing your thoughts...</div>';
  } else {
    const ph = editor.querySelector('.placeholder');
    if(ph) ph.remove();
  }
}

function updateToolbarStates(){
  try {
    boldBtn.classList.toggle('active', document.queryCommandState('bold'));
    italicBtn.classList.toggle('active', document.queryCommandState('italic'));
    underlineBtn.classList.toggle('active', document.queryCommandState('underline'));
  } catch(e){}
}

/* ---------- Editor commands (behavior like 'paint/word' - toggles apply to typing) ---------- */
function execCmd(cmd, val=null){ try{ document.execCommand(cmd, false, val); }catch(e){} editor.focus(); updateToolbarStates(); }
boldBtn.onclick = ()=> execCmd('bold');
italicBtn.onclick = ()=> execCmd('italic');
underlineBtn.onclick = ()=> execCmd('underline');
highlightBtn.onclick = ()=> { const col = '#fff59b'; try{ execCmd('hiliteColor', col) } catch(e){ execCmd('backColor', col) } };

// text color palette
const palette = ['#000000','#333333','#555555','#8B5CF6','#2563EB','#10B981','#F59E0B','#EF4444','#FFFFFF','#FFD3B6','#BDE0FE','#FFD6F0'];
function buildPalette(container, cb){
  container.innerHTML = '';
  palette.forEach(c=>{
    const s = document.createElement('div'); s.className='sw'; s.style.background = c; s.title=c;
    s.onclick = ()=> { cb(c); container.style.display='none'; };
    container.appendChild(s);
  });
}
buildPalette(textColorPopup, c=> execCmd('foreColor', c));
buildPalette(bgColorPopup, c=> { try{ execCmd('hiliteColor', c) }catch(e){ execCmd('backColor', c) } });

textColorBtn.onclick = (e)=> { textColorPopup.style.display = textColorPopup.style.display === 'none' ? 'grid' : 'none'; }
bgColorBtn.onclick = (e)=> { bgColorPopup.style.display = bgColorPopup.style.display === 'none' ? 'grid' : 'none'; }

// font & size apply
fontSelect.onchange = ()=> { editor.style.fontFamily = fontSelect.value; settingsMeta.font = fontSelect.value; saveSettings().catch(()=>{}); }
sizeSelect.onchange = ()=> { editor.style.fontSize = sizeSelect.value; settingsMeta.size = sizeSelect.value; saveSettings().catch(()=>{}); }

// page bg controls
pageBgColor.oninput = async (e)=> { settingsMeta.background = e.target.value; applySettingsMeta(); await saveSettings(); statusText.textContent = 'Saved page color'; }
applyBgUrl.onclick = async ()=> { const u = pageBgURL.value.trim(); if(!u){ alert('Enter image URL'); return; } settingsMeta.background = u; applySettingsMeta(); await saveSettings(); alert('Page background saved'); }

// theme toggle
themeToggle.onclick = async ()=> { settingsMeta.theme = (document.body.getAttribute('data-theme') === 'dark') ? 'light' : 'dark'; applySettingsMeta(); await saveSettings(); }

/* ---------- Calendar: load index and render ---------- */
async function loadEntriesIndexForMonth(year, month){
  entriesIndex = {};
  const days = new Date(year, month+1, 0).getDate();
  const checks = [];
  for(let d=1; d<=days; d++){
    const key = toYMD(new Date(year, month, d));
    checks.push((async ()=>{
      try {
        const snap = await getDoc(userDocRef(['entries', key]));
        if(snap.exists()) entriesIndex[key] = true;
      } catch(e){}
    })());
  }
  await Promise.all(checks);
}

function renderCalendar(year, month){
  calendarYear = year; calendarMonth = month;
  const first = new Date(year, month, 1);
  const startWeekday = first.getDay();
  const daysInMonth = new Date(year, month+1, 0).getDate();
  monthLabel.textContent = first.toLocaleString(undefined,{month:'long', year:'numeric'});
  calendarGrid.innerHTML = '';
  for(let i=0;i<startWeekday;i++){ const el=document.createElement('div'); el.className='dayCell disabled'; calendarGrid.appendChild(el); }
  for(let d=1; d<=daysInMonth; d++){
    const dt = new Date(year, month, d);
    const key = toYMD(dt);
    const cell = document.createElement('div'); cell.className='dayCell';
    const num = document.createElement('div'); num.className='num'; num.textContent = d;
    cell.appendChild(num);
    const dot = document.createElement('div'); dot.className='dot';
    if(entriesIndex[key]) cell.classList.add('hasEntry');
    cell.appendChild(dot);
    const todayKey = toYMD(new Date());
    if(key === todayKey) cell.classList.add('today');
    cell.onclick = async ()=> { await selectDate(key, dt); };
    if(key === selectedDate) cell.classList.add('selected');
    calendarGrid.appendChild(cell);
  }
}

function clearCalendarSelection(){ calendarGrid.querySelectorAll('.dayCell').forEach(c=>c.classList.remove('selected')); }

async function selectDate(key, dt){
  selectedDate = key;
  clearCalendarSelection();
  calendarGrid.querySelectorAll('.dayCell').forEach(n=>{
    const num = n.querySelector('.num')?.textContent;
    if(num && parseInt(num,10) === dt.getDate()) n.classList.add('selected');
  });
  selectedDateSpan.textContent = formatNice(key);
  await loadEntry(key);
  updateEditModeForDate(key);
}

function updateEditModeForDate(key){
  const dd = new Date(key + 'T00:00:00');
  const today = new Date(); today.setHours(0,0,0,0);
  if(dd > today){
    editModeSpan.textContent = 'Future â€” view only';
    editor.setAttribute('contenteditable','false');
    saveBtn.disabled = true;
  } else {
    editModeSpan.textContent = 'Editable';
    editor.setAttribute('contenteditable','true');
    saveBtn.disabled = false;
  }
}

// month nav
prevMonthBtn.onclick = async ()=> { calendarMonth--; if(calendarMonth<0){calendarMonth=11;calendarYear--;} await loadEntriesIndexForMonth(calendarYear, calendarMonth); renderCalendar(calendarYear, calendarMonth); };
nextMonthBtn.onclick = async ()=> { calendarMonth++; if(calendarMonth>11){calendarMonth=0;calendarYear++;} await loadEntriesIndexForMonth(calendarYear, calendarMonth); renderCalendar(calendarYear, calendarMonth); };

// keyboard shortcuts
document.addEventListener('keydown', (e)=> {
  if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='b'){ e.preventDefault(); execCmd('bold'); }
  if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='i'){ e.preventDefault(); execCmd('italic'); }
  if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='u'){ e.preventDefault(); execCmd('underline'); }
});

// helper exec wrapper
function execCmd(cmd,val=null){ try{ document.execCommand(cmd,false,val); }catch(e){} editor.focus(); updateToolbarStates(); }

/* ---------- Auth + Init ---------- */
async function init(){
  try {
    const cred = await signInAnonymously(auth);
    uid = cred.user.uid;
    // show login (unchanged appearance)
    document.getElementById('login').style.display = 'block';
    // prepare UI: set initial month and selection to local today
    const today = new Date();
    calendarYear = today.getFullYear(); calendarMonth = today.getMonth(); selectedDate = toYMD(today);
    selectedDateSpan.textContent = formatNice(selectedDate);
    // pre-build palettes
    buildPaletteFor(textColorPopup);
    buildPaletteFor(bgColorPopup);
  } catch(e){
    console.error('anonymous auth failed', e);
    alert('Failed to authenticate with Firebase. Check console for details.');
  }
}
function buildPaletteFor(container){
  container.innerHTML=''; palette.forEach(c=>{ const s=document.createElement('div'); s.className='sw'; s.style.background=c; s.title=c; s.onclick=()=>{ container.style.display='none'; /* handled earlier via buildPalette() */ }; container.appendChild(s); });
}
await init();

/* ---------- Login flow: show app & load settings / calendar ---------- */
loginBtn.onclick = async ()=>{
  const pw = passwordInput.value;
  if(!pw){ alert('Enter password'); return; }
  currentPassword = pw;
  // show app instantly (same appearance behavior you requested)
  loginDiv.style.display = 'none';
  appRoot.style.display = 'block';
  // load settings & then calendar + entries (heavy tasks run async so UI stays responsive)
  try { await loadSettings(); } catch(e){ console.warn('loadSettings error', e); }
  (async ()=>{
    try {
      await loadEntriesIndexForMonth(calendarYear, calendarMonth);
      renderCalendar(calendarYear, calendarMonth);
      await selectDate(selectedDate, new Date(selectedDate));
    } catch(e){ console.error('post-login init', e) }
  })();
};

/* ---------- Save / Change pass / Rename ---------- */
saveBtn.onclick = async ()=> { await saveEntry(selectedDate); };

changePassTop.onclick = async ()=>{
  const newPass = prompt('Enter new password (this will re-encrypt settings). Existing entries remain encrypted until re-encrypted manually.)');
  if(!newPass) return;
  currentPassword = newPass;
  await saveSettings();
  alert('Settings re-encrypted. To re-encrypt prior entries, you must decrypt/re-encrypt them individually.');
};

renameTop.onclick = async ()=>{
  const newName = prompt('Enter new diary name:');
  if(!newName) return;
  diaryName = newName;
  diaryTitleElem.textContent = diaryName;
  await saveSettings();
  alert('Diary renamed.');
};

/* ---------- Ensure placeholder & toolbar states on editor events ---------- */
editor.addEventListener('input', ()=>{ ensurePlaceholder(); updateToolbarStates(); });
editor.addEventListener('mouseup', updateToolbarStates);
editor.addEventListener('keyup', updateToolbarStates);

// close palette on outside click
document.addEventListener('click', (e)=>{
  if(!textColorBtn.contains(e.target) && !textColorPopup.contains(e.target)) textColorPopup.style.display='none';
  if(!bgColorBtn.contains(e.target) && !bgColorPopup.contains(e.target)) bgColorPopup.style.display='none';
});

</script>
</body>
</html>
