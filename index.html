<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>My Secret Diary ‚Äî Full</title>

<!-- Google fonts: many popular fonts included -->
<link href="https://fonts.googleapis.com/css2?
family=Quicksand:wght@300;400;500;700&
family=Inter:wght@300;400;600&
family=Poppins:wght@300;400;600&
family=Roboto:wght@300;400;700&
family=Open+Sans:wght@300;400;700&
family=Fredoka+One&family=Comic+Neue:wght@300;400;700&
family=Lato:wght@300;400;700&
family=Montserrat:wght@300;400;700&
family=Nunito:wght@300;400;700&
family=Raleway:wght@300;400;700&
family=Merriweather:wght@300;400;700&
family=Playfair+Display:wght@400;700&
family=Courier+Prime&family=Source+Sans+3:wght@300;400;600&
display=swap" rel="stylesheet">

<style>
  :root{
    --accent:#2563eb; --muted:#6b7280; --card:#fff; --bg:#f4f7fb; --danger:#ef4444; --radius:12px;
  }
  *{box-sizing:border-box}
  body{ margin:0; font-family:'Quicksand',system-ui,Segoe UI,Roboto,Arial; background:var(--bg); min-height:100vh; display:flex; align-items:center; justify-content:center; padding:18px; color:#0f1720; transition: background .25s, color .25s; }

  /* LOGIN (exactly preserved look but slightly bigger as requested) */
  #login {
    background: var(--card);
    border-radius: 16px;
    box-shadow: 0 8px 30px rgba(2,6,23,0.06);
    padding: 36px;
    width: 480px;
    max-width: 92%;
    text-align: center;
  }
  #login h1{ margin:0 0 10px; font-size:22px }
  #login p{ margin:0 0 10px; color:var(--muted) }
  #login input, #login button{ width:100%; margin-top:10px; padding:12px; border-radius:8px; border:1px solid #d1d5db; font-size:15px; font-family:inherit; }
  #login button{ background:var(--accent); color:white; border:none; cursor:pointer }
  #login button:hover{ filter:brightness(.95) }

  /* APP layout */
  #appRoot{ display:none; width:100%; max-width:1300px; height:86vh; background:transparent; }
  .appWrap{ display:flex; height:100%; gap:18px; align-items:stretch; position:relative; }

  /* left calendar */
  .leftCol{
    width:320px; background:linear-gradient(180deg,#ffffff,#f7fbff); border-radius:var(--radius); padding:16px; box-shadow:0 10px 30px rgba(2,6,23,0.06); display:flex; flex-direction:column;
  }
  .monthHeader{ display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:10px }
  .monthLabel{ font-weight:700 }
  .calendarGrid{ display:grid; grid-template-columns:repeat(7,1fr); gap:8px; }
  .dayCell{ height:46px; border-radius:10px; display:flex; align-items:center; justify-content:center; position:relative; cursor:pointer; transition: transform .08s, background .12s; background:transparent; user-select:none }
  .dayCell:hover{ transform:translateY(-3px) }
  .dayCell.today{ box-shadow: inset 0 0 0 2px rgba(37,99,235,0.08) }
  .dayCell.selected{ background:var(--accent); color:white; }
  .dot{ position:absolute; bottom:6px; width:8px; height:8px; background:var(--accent); border-radius:50%; display:none }
  .dayCell.hasEntry .dot{ display:block }
  .legend{ margin-top:12px; font-size:13px; color:var(--muted) }

  /* right editor */
  .rightCol{ flex:1; display:flex; flex-direction:column; gap:12px; padding:18px; border-radius:var(--radius); background:linear-gradient(180deg,#ffffff,#fbfdff); box-shadow:0 10px 30px rgba(2,6,23,0.06); position:relative; overflow:hidden; }

  .topBar{ display:flex; justify-content:space-between; align-items:center; gap:12px; }
  .titleBlock{ display:flex; flex-direction:column; gap:4px }
  .titleBlock .title{ font-size:20px; font-weight:700 }
  .titleBlock .sub{ font-size:13px; color:var(--muted) }

  .topActions{ display:flex; gap:8px; align-items:center }
  .squareBtn{ display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:8px 12px; border-radius:10px; border:none; background:#f8fafc; cursor:pointer; font-weight:600; color:var(--muted); min-width:92px }
  .squareBtn.primary{ background:var(--accent); color:#fff; }

  .toolbar{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; padding:8px; border-radius:10px; background:rgba(10,20,40,0.03); }
  .toolTextBtn{ padding:8px 12px; border-radius:8px; border:1px solid rgba(0,0,0,0.06); background:#fff; cursor:pointer; font-weight:700 }
  .toolTextBtn.active{ background:var(--accent); color:#fff }
  .toolIconBtn{ width:36px; height:36px; border-radius:8px; border:1px solid rgba(0,0,0,0.06); background:#fff; display:inline-flex; align-items:center; justify-content:center; cursor:pointer }
  .toolIconBtn.active{ background:var(--accent); color:#fff }

  .colorPreview{ width:28px; height:20px; border-radius:6px; border:1px solid rgba(0,0,0,0.06); display:inline-block; vertical-align:middle; margin-left:6px }

  .editorWrap{ padding:12px; border-radius:12px; border:1px solid rgba(0,0,0,0.05); min-height:480px; overflow:auto; background: rgba(255,255,255,0.85) }
  .editor{ min-height:420px; outline:none; font-size:16px; color:inherit; background:transparent; padding:12px; white-space:pre-wrap }

  .saveFloating{ position:absolute; right:22px; bottom:22px; z-index:40; }

  .palette{ position:relative; display:inline-block; }
  .palettePopup{ position:absolute; top:46px; left:0; background:var(--card); padding:8px; border-radius:8px; display:grid; grid-template-columns: repeat(6,24px); gap:8px; box-shadow:0 8px 30px rgba(2,6,23,0.08); z-index:50 }
  .sw{ width:24px; height:24px; border-radius:6px; cursor:pointer; border:1px solid rgba(0,0,0,0.06) }

  /* toast */
  .toast { position: fixed; left: 50%; transform: translateX(-50%) translateY(12px); bottom: 28px; min-width: 160px; padding: 10px 14px; border-radius: 10px; color: #fff; font-weight: 600; text-align:center; z-index:9999; opacity:0; pointer-events:none; transition: opacity .22s, transform .22s; }
  .toast.show{ opacity:1; pointer-events:auto; transform: translateX(-50%) translateY(0); }
  .toast.ok{ background:#16a34a } .toast.err{ background:#ef4444 }

  /* dark */
  body.dark{ background:#071225; color:#e6eefc; }
  body.dark .leftCol{ background:linear-gradient(180deg,#071225,#0b1420); color:#e6eefc; }
  body.dark .rightCol{ background:linear-gradient(180deg,#071225,#06101a); color:#e6eefc }
  @media (max-width:980px){ .appWrap{ flex-direction:column; height:auto } .leftCol{ width:100%; order:2 } .rightCol{ order:1 } }
</style>
</head>
<body>

  <!-- LOGIN UNCHANGED (appearance & placement preserved) -->
  <div id="login">
    <h1>üîí My Secret Diary</h1>
    <p>Enter your diary password</p>
    <input type="password" id="passwordInput" placeholder="Password">
    <button id="loginBtn">Login</button>
  </div>

  <!-- APP -->
  <div id="appRoot" aria-hidden="true" style="display:none">
    <div class="appWrap">
      <div class="leftCol">
        <div class="monthHeader">
          <button id="prevMonth" class="toolIconBtn" title="Previous month">‚óÄ</button>
          <div class="monthLabel" id="monthLabel">Month</div>
          <button id="nextMonth" class="toolIconBtn" title="Next month">‚ñ∂</button>
        </div>

        <div class="calendarGrid" id="calendarGrid"></div>

        <div style="margin-top:12px; width:100%; display:flex; gap:8px; align-items:center; justify-content:space-between">
          <div style="font-size:13px; color:var(--muted)">Selected: <span id="selectedDate">‚Äî</span></div>
          <button id="goToday" class="toolIconBtn" title="Go to today">Today</button>
        </div>

        <div class="legend">
          <div style="display:flex; gap:8px; align-items:center; margin-top:12px"><div style="width:10px;height:10px;border-radius:50%;background:var(--accent);"></div><div>Saved Entry</div></div>
        </div>
      </div>

      <div class="rightCol">
        <div class="topBar">
          <div class="titleBlock">
            <div class="title" id="diaryTitle">My Secret Diary</div>
            <div class="sub">Encrypted locally ‚Ä¢ edit past & today</div>
          </div>

          <div class="topActions">
            <button id="saveTop" class="squareBtn primary">üíæ Save</button>
            <button id="renameTop" class="squareBtn">‚úèÔ∏è Rename</button>
            <button id="changePassTop" class="squareBtn">üîí Change Pass</button>
            <button id="themeToggleTop" class="squareBtn">Theme</button>
          </div>
        </div>

        <div class="toolbar" role="toolbar" aria-label="Formatting toolbar">
          <button id="btnBold" class="toolTextBtn" title="Bold">B</button>
          <button id="btnItalic" class="toolTextBtn" title="Italic">I</button>
          <button id="btnUnderline" class="toolTextBtn" title="Underline">U</button>
          <button id="btnStrike" class="toolTextBtn" title="Strike">S</button>

          <div style="width:8px"></div>

          <button id="btnHighlight" class="toolIconBtn" title="Highlight">üñç</button>

          <div style="width:8px"></div>

          <div class="palette">
            <button id="colorIcon" class="toolIconBtn" title="Text color">üé®</button>
            <div class="palettePopup" id="colorPopup" style="display:none"></div>
          </div>
          <span class="colorPreview" id="colorPreview" style="display:inline-block"></span>

          <div style="width:8px"></div>

          <button id="btnBullet" class="toolTextBtn" title="Bullet list">‚Ä¢ List</button>
          <button id="btnNumber" class="toolTextBtn" title="Numbered list">1. List</button>

          <div style="width:8px"></div>

          <button id="alignLeft" class="toolTextBtn" title="Align left">L</button>
          <button id="alignCenter" class="toolTextBtn" title="Align center">C</button>
          <button id="alignRight" class="toolTextBtn" title="Align right">R</button>

          <button id="clearFmt" class="toolTextBtn" title="Clear formatting">Clear</button>

          <label style="margin-left:12px; font-size:13px; color:var(--muted)">Font</label>
          <!-- searchable font filter + select -->
          <input id="fontFilter" placeholder="Search fonts..." style="padding:8px; border-radius:8px; border:1px solid rgba(0,0,0,0.06); min-width:180px" />
          <select id="fontSelect" style="padding:8px; border-radius:8px; border:1px solid rgba(0,0,0,0.06); min-width:200px">
            <!-- many options added by JS -->
          </select>

          <label style="font-size:13px; color:var(--muted)">Size</label>
          <select id="sizeSelect" style="padding:8px; border-radius:8px; border:1px solid rgba(0,0,0,0.06)">
            <option value="14px">14</option>
            <option value="16px" selected>16</option>
            <option value="18px">18</option>
            <option value="20px">20</option>
            <option value="22px">22</option>
            <option value="24px">24</option>
          </select>

          <label style="margin-left:12px; font-size:13px; color:var(--muted)">Background</label>
          <input id="bgInput" type="file" accept="image/*" style="padding:6px; border-radius:8px;" />
          <button id="removeBg" class="squareBtn" title="Remove background">Remove</button>
        </div>

        <div class="editorWrap" id="editorWrap">
          <div id="editor" class="editor" contenteditable="true" spellcheck="true" aria-label="Diary editor">
            <div class="placeholder" style="color:var(--muted)">Start writing your thoughts...</div>
          </div>
        </div>

        <div class="bottomRow">
          <div id="statusText" style="font-size:13px; color:var(--muted)"></div>
        </div>

        <div class="saveFloating">
          <button id="saveFloatingBtn" class="squareBtn primary">Save</button>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

<script type="module">
/* FULL working script:
   - Login UI unchanged
   - Rich editor with persistent formatting while typing
   - Searchable font selector with many fonts
   - Save/load encrypted HTML to Firestore at doc path: entries/YYYY-MM-DD
   - Settings saved at entries/settings (bg, name, password)
   - Calendar uses Asia/Kolkata timezone
   - fixes: Enter->Login, composition (IME), placeholder focus removal
*/

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

// Firebase config (kept as provided)
const firebaseConfig = {
  apiKey: "AIzaSyDRpLl01xtSZ7f0ZbId7zFASUJoem4L69s",
  authDomain: "my-secret-diary-9b62c.firebaseapp.com",
  projectId: "my-secret-diary-9b62c",
  storageBucket: "my-secret-diary-9b62c.firebasestorage.app",
  messagingSenderId: "139353851381",
  appId: "1:139353851381:web:3050a47540d36a2243ccbc"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// DOM refs
const loginDiv = document.getElementById('login');
const passwordInput = document.getElementById('passwordInput');
const loginBtn = document.getElementById('loginBtn');

const appRoot = document.getElementById('appRoot');
const calendarGrid = document.getElementById('calendarGrid');
const monthLabel = document.getElementById('monthLabel');
const prevMonth = document.getElementById('prevMonth');
const nextMonth = document.getElementById('nextMonth');
const selectedDateSpan = document.getElementById('selectedDate');
const goToday = document.getElementById('goToday');

const diaryTitle = document.getElementById('diaryTitle');
const saveTop = document.getElementById('saveTop');
const renameTop = document.getElementById('renameTop');
const changePassTop = document.getElementById('changePassTop');
const themeToggleTop = document.getElementById('themeToggleTop');

const btnBold = document.getElementById('btnBold');
const btnItalic = document.getElementById('btnItalic');
const btnUnderline = document.getElementById('btnUnderline');
const btnStrike = document.getElementById('btnStrike');
const btnHighlight = document.getElementById('btnHighlight');

const colorIcon = document.getElementById('colorIcon');
const colorPopup = document.getElementById('colorPopup');
const colorPreview = document.getElementById('colorPreview');

const btnBullet = document.getElementById('btnBullet');
const btnNumber = document.getElementById('btnNumber');
const alignLeft = document.getElementById('alignLeft');
const alignCenter = document.getElementById('alignCenter');
const alignRight = document.getElementById('alignRight');
const clearFmt = document.getElementById('clearFmt');

const fontSelect = document.getElementById('fontSelect');
const fontFilter = document.getElementById('fontFilter');
const sizeSelect = document.getElementById('sizeSelect');
const bgInput = document.getElementById('bgInput');
const removeBg = document.getElementById('removeBg');

const editor = document.getElementById('editor');
const saveFloatingBtn = document.getElementById('saveFloatingBtn');

const toastEl = document.getElementById('toast');

let storedPassword = "53458678";
let diaryName = "My Secret Diary";
let currentPassword = null;
let settingsMeta = { theme:'light', background:null, font:'Quicksand', size:'16px' };

let calendarYear = (new Date()).getFullYear();
let calendarMonth = (new Date()).getMonth();
let selectedDate = null;
let entriesIndex = {};

// typing styling state
let currentColor = null;
let highlightActive = false;
const highlightColor = '#fff59b';

// IME composition flag so we don't break multi-key input
let isComposing = false;
editor.addEventListener('compositionstart', ()=> { isComposing = true; });
editor.addEventListener('compositionend', ()=> { isComposing = false; });

// palette
const paletteColors = ['#000000','#333333','#555555','#8B5CF6','#2563EB','#10B981','#F59E0B','#EF4444','#FFFFFF','#FFD3B6','#BDE0FE','#FFD6F0'];
function createColorSwatches(){
  colorPopup.innerHTML = '';
  paletteColors.forEach(c=>{
    const s = document.createElement('div');
    s.className='sw';
    s.style.background = c;
    s.title = c;
    s.onclick = ()=> {
      // Apply to selection if any
      try{ document.execCommand('styleWithCSS', false, true); }catch(e){}
      try{ document.execCommand('foreColor', false, c); }catch(e){}
      // Also set typing color
      currentColor = c;
      colorPreview.style.background = c;
      colorPreview.title = c;
      colorPopup.style.display = 'none';
      colorIcon.classList.add('active');
      updateToolbarStates();
      editor.focus();
    };
    colorPopup.appendChild(s);
  });
}
createColorSwatches();
colorIcon.onclick = ()=> { colorPopup.style.display = colorPopup.style.display === 'block' ? 'none' : 'block'; };

// close popup on outside click
document.addEventListener('click', e => {
  if(!colorIcon.contains(e.target) && !colorPopup.contains(e.target)) colorPopup.style.display = 'none';
});

// toast helper
let toastTimer = null;
function showToast(msg, ok=true){
  toastEl.textContent = msg;
  toastEl.className = `toast ${ok ? 'ok' : 'err'} show`;
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=> { toastEl.className = 'toast'; }, 1500);
}

// timezone helper (India)
function getYMDInTimeZone(timeZone='Asia/Kolkata', d=new Date()){
  const parts = new Intl.DateTimeFormat('en-CA', { timeZone, year:'numeric', month:'2-digit', day:'2-digit' }).formatToParts(d);
  const obj = {}; parts.forEach(p=>obj[p.type]=p.value);
  return `${obj.year}-${obj.month}-${obj.day}`;
}
const toYMD = d => (new Date(d)).toISOString().slice(0,10);

// crypto helpers (PBKDF2 + AES-GCM)
function b64(arr){ return btoa(String.fromCharCode(...arr)); }
function fromB64(s){ return Uint8Array.from(atob(s), c=>c.charCodeAt(0)); }

async function deriveKey(password, salt) {
  const enc = new TextEncoder();
  const base = await crypto.subtle.importKey('raw', enc.encode(password), {name:'PBKDF2'}, false, ['deriveKey']);
  return crypto.subtle.deriveKey({ name:'PBKDF2', salt, iterations:150000, hash:'SHA-256' }, base, { name:'AES-GCM', length:256 }, false, ['encrypt','decrypt']);
}
async function encryptPayload(password, payloadObj){
  const salt = crypto.getRandomValues(new Uint8Array(16));
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const key = await deriveKey(password, salt);
  const enc = new TextEncoder();
  const data = enc.encode(JSON.stringify(payloadObj));
  const cipher = await crypto.subtle.encrypt({ name:'AES-GCM', iv }, key, data);
  return { cipher: b64(new Uint8Array(cipher)), iv: b64(iv), salt: b64(salt) };
}
async function decryptPayload(password, docData){
  const iv = fromB64(docData.iv);
  const salt = fromB64(docData.salt);
  const key = await deriveKey(password, salt);
  const cipherBuf = fromB64(docData.cipher);
  const plain = await crypto.subtle.decrypt({ name:'AES-GCM', iv }, key, cipherBuf);
  return JSON.parse(new TextDecoder().decode(plain));
}

// SETTINGS LOADING
async function loadSettings(){
  try{
    const sRef = doc(db, 'entries', 'settings');
    const snap = await getDoc(sRef);
    if(snap.exists()){
      const data = snap.data();
      storedPassword = data.password || storedPassword;
      diaryName = data.name || diaryName;
      if(data.bg) settingsMeta.background = data.bg;
      diaryTitle.textContent = diaryName;
      applySettingsMeta();
    } else {
      // create default settings
      await setDoc(sRef, { password: storedPassword, name: diaryName, bg: settingsMeta.background || "" });
    }
  } catch(e){
    console.warn('loadSettings error', e);
  }
}

// calendar index for month
async function loadEntriesIndexForMonth(year, month){
  entriesIndex = {};
  const days = new Date(year, month+1, 0).getDate();
  const promises = [];
  for(let d=1; d<=days; d++){
    const key = toYMD(new Date(year, month, d));
    promises.push((async ()=>{
      try{
        const snap = await getDoc(doc(db,'entries', key));
        if(snap.exists()) entriesIndex[key] = true;
      }catch(e){}
    })());
  }
  await Promise.all(promises);
}

// render calendar
function renderCalendar(year, month){
  calendarYear = year; calendarMonth = month;
  const first = new Date(year, month, 1);
  const startWeekday = first.getDay();
  const daysInMonth = new Date(year, month+1, 0).getDate();
  monthLabel.textContent = first.toLocaleString(undefined,{month:'long', year:'numeric'});
  calendarGrid.innerHTML = '';
  for(let i=0;i<startWeekday;i++){ const el=document.createElement('div'); el.className='dayCell disabled'; calendarGrid.appendChild(el); }
  for(let d=1; d<=daysInMonth; d++){
    const dt = new Date(year, month, d);
    const key = toYMD(dt);
    const cell = document.createElement('div');
    cell.className='dayCell';
    cell.textContent = d;
    const dot = document.createElement('div'); dot.className='dot';
    if(entriesIndex[key]) cell.classList.add('hasEntry');
    cell.appendChild(dot);
    const todayKey = getYMDInTimeZone('Asia/Kolkata', new Date());
    if(key === todayKey) cell.classList.add('today');
    cell.onclick = async ()=> { await selectDate(key, dt); };
    if(key === selectedDate) cell.classList.add('selected');
    calendarGrid.appendChild(cell);
  }
}

// select date
async function selectDate(key, dt){
  selectedDate = key;
  selectedDateSpan.textContent = new Date(key).toLocaleDateString(undefined, { timeZone:'Asia/Kolkata' });
  calendarGrid.querySelectorAll('.dayCell').forEach(c=>c.classList.remove('selected'));
  calendarGrid.querySelectorAll('.dayCell').forEach(n=>{
    const txt = n.textContent && n.textContent.trim();
    if(txt && parseInt(txt,10) === dt.getDate()) n.classList.add('selected');
  });
  await loadEntryForDate(key);
  updateEditModeForDate(key);
}
function updateEditModeForDate(key){
  const dd = new Date(key + 'T00:00:00');
  const todayStr = getYMDInTimeZone('Asia/Kolkata', new Date());
  const today = new Date(todayStr + 'T00:00:00');
  if(dd > today){
    editor.setAttribute('contenteditable','false');
    saveTop.disabled = saveFloatingBtn.disabled = true;
  } else {
    editor.setAttribute('contenteditable','true');
    saveTop.disabled = saveFloatingBtn.disabled = false;
  }
}

// execCommand helpers
try{ document.execCommand('styleWithCSS', false, true); }catch(e){}
function execCmd(cmd, value=null){
  try{ document.execCommand('styleWithCSS', false, true); }catch(e){}
  try{ document.execCommand(cmd, false, value); }catch(e){ console.warn('exec failed', cmd, e) }
  editor.focus();
  updateToolbarStates();
}
function updateToolbarStates(){
  try{
    btnBold.classList.toggle('active', document.queryCommandState('bold'));
    btnItalic.classList.toggle('active', document.queryCommandState('italic'));
    btnUnderline.classList.toggle('active', document.queryCommandState('underline'));
    btnStrike.classList.toggle('active', document.queryCommandState('strikeThrough'));
    btnHighlight.classList.toggle('active', highlightActive);
    colorIcon.classList.toggle('active', !!currentColor);
    if(currentColor) colorPreview.style.background = currentColor; else colorPreview.style.background = '';
  }catch(e){}
}

// toolbar bindings
btnBold.onclick = ()=> execCmd('bold');
btnItalic.onclick = ()=> execCmd('italic');
btnUnderline.onclick = ()=> execCmd('underline');
btnStrike.onclick = ()=> execCmd('strikeThrough');

btnBullet.onclick = ()=> execCmd('insertUnorderedList');
btnNumber.onclick = ()=> execCmd('insertOrderedList');

alignLeft.onclick = ()=> execCmd('justifyLeft');
alignCenter.onclick = ()=> execCmd('justifyCenter');
alignRight.onclick = ()=> execCmd('justifyRight');

clearFmt.onclick = ()=> execCmd('removeFormat');

btnHighlight.onclick = ()=> {
  highlightActive = !highlightActive;
  btnHighlight.classList.toggle('active', highlightActive);
  const sel = window.getSelection();
  if(sel && sel.rangeCount && !sel.getRangeAt(0).collapsed){
    try{ document.execCommand('styleWithCSS', false, true); }catch(e){}
    try{ document.execCommand('hiliteColor', false, highlightColor); }catch(e){ try{ document.execCommand('backColor', false, highlightColor); }catch(e){} }
  }
  editor.focus();
};

// beforeinput intercept so typing applies currentColor/highlight when caret collapsed
editor.addEventListener('beforeinput', (e)=>{
  if(isComposing) return; // don't intercept while IME composing
  if(e.inputType === 'insertText' && e.data && e.data.length > 0){
    const sel = window.getSelection();
    if(!sel.rangeCount) return;
    const range = sel.getRangeAt(0);
    if(!range.collapsed) return; // selection present -> execCommand will apply
    if(!highlightActive && !currentColor) return; // nothing special; let browser do default
    e.preventDefault();
    const span = document.createElement('span');
    if(currentColor) span.style.color = currentColor;
    if(highlightActive) span.style.backgroundColor = highlightColor;
    span.textContent = e.data;
    range.insertNode(span);
    // move caret after span
    range.setStartAfter(span);
    range.setEndAfter(span);
    sel.removeAllRanges();
    sel.addRange(range);
    updateToolbarStates();
  }
});

// placeholder management
function ensurePlaceholder(){
  if(!editor.innerText.trim()){
    if(!editor.querySelector('.placeholder')){
      editor.innerHTML = '<div class="placeholder" style="color:var(--muted)">Start writing your thoughts...</div>';
    }
  } else {
    const ph = editor.querySelector('.placeholder');
    if(ph) ph.remove();
  }
}
editor.addEventListener('input', ()=>{ ensurePlaceholder(); updateToolbarStates(); });
editor.addEventListener('mouseup', updateToolbarStates);
editor.addEventListener('keyup', updateToolbarStates);

// when focusing editor, remove placeholder so typing is straightforward
editor.addEventListener('focus', ()=> {
  const ph = editor.querySelector('.placeholder');
  if(ph) ph.remove();
  updateToolbarStates();
});

// fonts list (many popular fonts). We added Google font links above to load them.
const FONTS = [
 'Quicksand','Inter','Poppins','Roboto','Open Sans','Fredoka One','Comic Neue','Lato','Montserrat','Nunito',
 'Raleway','Merriweather','Playfair Display','Courier Prime','Source Sans 3','Oswald','Bebas Neue','PT Sans',
 'Arvo','Bitter','Cabin','Mukta','Fira Sans','Nunito Sans','Rubik','Kanit','Orbitron','Varela Round','Satisfy',
 'Comfortaa','Bangers','Dancing Script','Indie Flower','Archivo','Hind','Manrope','Abhaya Libre','Josefin Sans',
 'Cinzel','Alegreya','Work Sans','Anton','Baloo 2','Fredoka','Cormorant Garamond','Titillium Web','Barlow'
];

function populateFontSelect(list){
  fontSelect.innerHTML = '';
  list.forEach(f=>{
    const o = document.createElement('option');
    o.value = f;
    o.textContent = f;
    fontSelect.appendChild(o);
  });
}
populateFontSelect(FONTS);

// filter box to search fonts
fontFilter.addEventListener('input', ()=> {
  const q = fontFilter.value.trim().toLowerCase();
  if(!q) { populateFontSelect(FONTS); return; }
  const filtered = FONTS.filter(f=> f.toLowerCase().includes(q));
  populateFontSelect(filtered);
});

// apply font & size visually to editor
fontSelect.onchange = ()=> { editor.style.fontFamily = fontSelect.value; settingsMeta.font = fontSelect.value; };
sizeSelect.onchange = ()=> { editor.style.fontSize = sizeSelect.value; settingsMeta.size = sizeSelect.value; };

// encryption wrappers for entries
async function encryptEntry(password, payload){ return await encryptPayload(password, payload); }
async function decryptEntry(password, docData){ return await decryptPayload(password, docData); }

// load entry
async function loadEntryForDate(key){
  try{
    const snap = await getDoc(doc(db,'entries', key));
    if(!snap.exists()){
      editor.innerHTML = '<div class="placeholder" style="color:var(--muted)">Start writing your thoughts...</div>';
      ensurePlaceholder();
      return;
    }
    const data = snap.data();
    if(data.cipher && data.iv && data.salt){
      try{
        const payload = await decryptEntry(currentPassword, data);
        editor.innerHTML = payload.html || '';
        settingsMeta = payload.meta || settingsMeta;
        diaryName = payload.diaryName || diaryName;
        diaryTitle.textContent = diaryName;
        applySettingsMeta();
      } catch(e){
        editor.innerHTML = '<div class="placeholder" style="color:var(--muted)">Unable to decrypt this entry (wrong password).</div>';
      }
    } else if(data.text){
      editor.innerHTML = data.text || '';
    } else {
      editor.innerHTML = '<div class="placeholder" style="color:var(--muted)">Empty</div>';
    }
  } catch(e){ console.error('loadEntryForDate', e) }
}

// save entry (encrypted)
async function saveEntryForDate(key){
  const dd = new Date(key + 'T00:00:00');
  const todayStr = getYMDInTimeZone('Asia/Kolkata', new Date());
  const today = new Date(todayStr + 'T00:00:00');
  if(dd > today) { showToast('Cannot save future entries', false); return false; }
  ensurePlaceholder();
  const html = editor.innerHTML;
  const payload = { html, meta: settingsMeta, diaryName, savedAt: new Date().toISOString() };
  try{
    const enc = await encryptEntry(currentPassword, payload);
    await setDoc(doc(db,'entries', key), { ...enc, savedAt: serverTimestamp() });
    entriesIndex[key] = true;
    await loadEntriesIndexForMonth(calendarYear, calendarMonth);
    renderCalendar(calendarYear, calendarMonth);
    showToast('Saved', true);
    return true;
  } catch(e){
    console.error('saveEntryForDate', e);
    showToast('Save failed', false);
    return false;
  }
}

// apply settings meta visually
function applySettingsMeta(){
  document.body.classList.toggle('dark', settingsMeta.theme === 'dark');
  const rc = document.querySelector('.rightCol');
  if(settingsMeta.background){
    rc.style.backgroundImage = `url("${settingsMeta.background}")`;
    rc.style.backgroundSize = 'cover';
    rc.style.backgroundPosition = 'center';
  } else rc.style.backgroundImage = '';
  if(settingsMeta.font) fontSelect.value = settingsMeta.font;
  if(settingsMeta.size) sizeSelect.value = settingsMeta.size;
  editor.style.fontFamily = fontSelect.value;
  editor.style.fontSize = sizeSelect.value;
}

// save settings doc (bg, name, password)
async function saveSettingsDoc(showToastMsg=false){
  try{
    await setDoc(doc(db,'entries','settings'), { password: storedPassword, name: diaryName, bg: settingsMeta.background || "" });
    if(showToastMsg) showToast('Settings saved', true);
    return true;
  } catch(e){
    console.error('saveSettingsDoc', e);
    if(showToastMsg) showToast('Settings save failed', false);
    return false;
  }
}

// load entries index utility used earlier
async function loadEntriesIndexForMonth(year, month){
  entriesIndex = {};
  const days = new Date(year, month+1, 0).getDate();
  const promises = [];
  for(let d=1; d<=days; d++){
    const key = toYMD(new Date(year, month, d));
    promises.push((async ()=>{
      try{
        const snap = await getDoc(doc(db,'entries', key));
        if(snap.exists()) entriesIndex[key] = true;
      }catch(e){}
    })());
  }
  await Promise.all(promises);
}

// INITIALIZE: load settings and calendar
await loadSettings();
(async ()=>{
  const todayStr = getYMDInTimeZone('Asia/Kolkata', new Date());
  calendarYear = new Date(todayStr).getFullYear();
  calendarMonth = new Date(todayStr).getMonth();
  selectedDate = todayStr;
  selectedDateSpan.textContent = new Date(selectedDate).toLocaleDateString(undefined,{timeZone:'Asia/Kolkata'});
  await loadEntriesIndexForMonth(calendarYear, calendarMonth);
  renderCalendar(calendarYear, calendarMonth);
  await selectDate(selectedDate, new Date(selectedDate));
})();

// LOGIN FLOW (keeps original appearance & mechanics)
// Add Enter key to trigger login
passwordInput.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter'){ e.preventDefault(); loginBtn.click(); }
});

loginBtn.onclick = async ()=>{
  await loadSettings();
  if(passwordInput.value === storedPassword){
    currentPassword = passwordInput.value;
    loginDiv.style.display = 'none';
    appRoot.style.display = 'block';
    applySettingsMeta();
    await selectDate(selectedDate, new Date(selectedDate));
  } else {
    alert('Wrong password!');
  }
};

// month nav & today
prevMonth.onclick = async ()=>{ calendarMonth--; if(calendarMonth<0){calendarMonth=11;calendarYear--;} await loadEntriesIndexForMonth(calendarYear, calendarMonth); renderCalendar(calendarYear, calendarMonth); };
nextMonth.onclick = async ()=>{ calendarMonth++; if(calendarMonth>11){calendarMonth=0;calendarYear++;} await loadEntriesIndexForMonth(calendarYear, calendarMonth); renderCalendar(calendarYear, calendarMonth); };
goToday.onclick = async ()=>{ const todayStr = getYMDInTimeZone('Asia/Kolkata', new Date()); calendarYear=new Date(todayStr).getFullYear(); calendarMonth=new Date(todayStr).getMonth(); await loadEntriesIndexForMonth(calendarYear, calendarMonth); renderCalendar(calendarYear, calendarMonth); await selectDate(todayStr, new Date(todayStr)); };

// save buttons
saveTop.onclick = saveFloatingBtn.onclick = async ()=>{ if(!selectedDate) return; await saveEntryForDate(selectedDate); };

// rename & change pass & theme toggle
renameTop.onclick = async ()=>{ const newName = prompt('Enter new diary name:'); if(!newName) return; diaryName = newName; diaryTitle.textContent = diaryName; await saveSettingsDoc(true); };
changePassTop.onclick = async ()=>{ const newPass = prompt('Enter new password:'); if(!newPass) return; storedPassword = newPass; await saveSettingsDoc(true); };
themeToggleTop.onclick = async ()=>{ settingsMeta.theme = settingsMeta.theme === 'dark' ? 'light' : 'dark'; applySettingsMeta(); await saveSettingsDoc(false); };

// background upload & remove
bgInput.onchange = async (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = async (ev)=>{
    settingsMeta.background = ev.target.result;
    applySettingsMeta();
    const ok = await saveSettingsDoc(false);
    if(!ok) showToast('Background save failed', false);
  };
  reader.readAsDataURL(f);
};
removeBg.onclick = async ()=>{ settingsMeta.background = null; applySettingsMeta(); const ok = await saveSettingsDoc(false); if(!ok) showToast('Remove background failed', false); };

// keyboard shortcuts
document.addEventListener('keydown', (e)=>{
  if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='b'){ e.preventDefault(); execCmd('bold'); }
  if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='i'){ e.preventDefault(); execCmd('italic'); }
  if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='u'){ e.preventDefault(); execCmd('underline'); }
});

// initial placeholder + toolbar state
ensurePlaceholder();
updateToolbarStates();

</script>
</body>
</html>
