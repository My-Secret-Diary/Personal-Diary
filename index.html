<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Secret Diary</title>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&family=Patrick+Hand&display=swap" rel="stylesheet">
  <style>
    :root{
      --accent:#1f6feb;
      --accent-active:#0b63d6;
      --muted:#6b7280;
      --bg-light:#f6f9fc;
      --card:#fffdf8;
      --paper:#fffef6;
      --shadow: 0 8px 30px rgba(16,24,40,0.06);
      --success:#25a26a;
    }
    *{box-sizing:border-box}
    body{font-family:Quicksand,Arial,Helvetica,sans-serif;background:var(--bg-light);margin:0;padding:22px;display:flex;justify-content:center}
    .container{width:100%;max-width:1100px}
    /* login kept identical visually to user's requirement */
    #login{background:white;border-radius:20px;box-shadow:0 6px 30px rgba(0,0,0,0.08);padding:40px;width:820px;margin:0 auto}
    #login h1{margin:0 0 12px;text-align:center}
    #login p{margin:0 0 10px;text-align:center;color:var(--muted)}
    #login input, #login button{display:block;margin:10px auto 0;width:360px;max-width:92%}
    #login button{padding:10px;border-radius:10px;border:none;background:var(--accent);color:white;font-weight:600;cursor:pointer}

    /* diary layout */
    #diaryWrap{display:none;margin:0 auto}
    .diaryHeader{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,#fff,#f2efe6);display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow)}
    .logo span{font-weight:700;color:var(--accent);font-size:20px}
    h1.title{margin:0;font-size:20px}
    .controls-top{display:flex;gap:10px;align-items:center}
    .controls-top button{padding:8px 12px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:#fff;cursor:pointer}
    .controls-top .primary{background:var(--accent);color:#fff;border:none}

    .layout{display:grid;grid-template-columns:320px 1fr;gap:18px;align-items:start}
    .panel{background:var(--card);border-radius:12px;padding:16px;box-shadow:var(--shadow)}
    /* calendar */
    .month-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .dayname{font-size:12px;color:var(--muted);text-align:center}
    .date{min-height:72px;border-radius:8px;padding:8px;background:linear-gradient(180deg,#fff,#fbfdff);border:1px solid #f0f3f7;cursor:pointer}
    .date.today{outline:2px solid #fde68a}
    .date.has{box-shadow:inset 0 -4px 0 rgba(31,111,235,0.06)}
    .date .num{font-weight:600}
    .date .preview{font-size:12px;color:var(--muted);margin-top:6px;max-height:36px;overflow:hidden}

    /* editor */
    .editor-wrap{display:flex;flex-direction:column}
    .editor-meta{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
    .controls-left{display:flex;gap:8px;align-items:center}
    .format-btn{padding:8px;border-radius:8px;border:1px solid #e6e9ef;background:#f4f6f8;cursor:pointer}
    .format-btn.active{background:var(--accent);color:white;border-color:var(--accent-active)}
    .color-btn{display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px;border:1px solid #e6e9ef;background:#fff;cursor:pointer}
    .editor{border-radius:10px;padding:18px;background:var(--paper);min-height:420px;border:1px solid #efe9d6;overflow:auto}
    .editor[contenteditable]{outline:none;font-family: 'Patrick Hand', Georgia, serif;font-size:18px;line-height:1.6;color:#111}

    .bottom-actions{display:flex;justify-content:space-between;align-items:center;margin-top:12px;gap:10px}
    .right-actions{margin-left:auto;display:flex;gap:8px}
    .btn{padding:10px 14px;border-radius:10px;border:none;background:var(--accent);color:#fff;cursor:pointer}
    .btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(31,111,235,0.12)}
    .btn.warn{background:#ef5350}
    .muted{color:var(--muted);font-size:13px}

    /* top-right outside writer buttons bigger and visible */
    .top-right-actions{display:flex;gap:10px;align-items:center}

    /* theme & background */
    .theme-toggle{padding:6px 10px;border-radius:8px;border:1px solid #ddd;background:#fff}
    .bg-upload{font-size:13px;color:var(--muted)}

    /* disabled */
    .disabled{opacity:0.5;pointer-events:none}

    @media (max-width:900px){
      .layout{grid-template-columns:1fr}
      #login,#diaryWrap{width:95%}
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- LOGIN (unchanged) -->
    <div id="login">
      <h1>üîí My Secret Diary</h1>
      <p>Enter your diary password</p>
      <input type="password" id="passwordInput" placeholder="Password">
      <button id="loginBtn">Login</button>
    </div>

    <!-- DIARY -->
    <div id="diaryWrap" style="display:none">
      <div class="diaryHeader">
        <div class="brand">
          <div class="logo"><span>D</span></div>
          <div>
            <h1 class="title" id="diaryTitle">My Secret Diary</h1>
            <div class="muted">Private ‚Äî synced & encrypted</div>
          </div>
        </div>

        <!-- top-right outside writer big buttons -->
        <div class="top-right-actions">
          <label class="bg-upload">
            <input type="file" id="bgUpload" accept="image/*" style="display:none">
            <button class="controls-top" id="bgBtn" title="Upload background">Background</button>
          </label>

          <select id="themeSelect" class="theme-toggle" title="Theme">
            <option value="light">Light</option>
            <option value="dark">Dark</option>
          </select>

          <div style="display:flex;gap:8px">
            <button id="renameBtnTop" class="controls-top" title="Rename diary">Rename</button>
            <button id="changePassBtnTop" class="controls-top" title="Change password">Change password</button>
          </div>
        </div>
      </div>

      <div class="layout">
        <!-- Calendar panel -->
        <div class="panel">
          <div class="month-head">
            <h3 id="monthLabel">Month</h3>
            <div>
              <button id="prevMonth" class="controls-top">‚óÄ</button>
              <button id="nextMonth" class="controls-top">‚ñ∂</button>
            </div>
          </div>

          <div class="cal-grid" id="calNames">
            <div class="dayname">Sun</div><div class="dayname">Mon</div><div class="dayname">Tue</div><div class="dayname">Wed</div><div class="dayname">Thu</div><div class="dayname">Fri</div><div class="dayname">Sat</div>
          </div>

          <div class="cal-grid" id="calGrid" style="margin-top:10px"></div>
          <div style="margin-top:10px" class="muted">Click any date to open that day. Future dates are read-only.</div>
        </div>

        <!-- Editor panel -->
        <div class="panel editor-wrap">
          <div class="editor-meta">
            <div class="controls-left">
              <div style="display:flex;gap:8px;align-items:center">
                <button class="format-btn format-toggle" data-cmd="bold" id="btnBold"><b>B</b></button>
                <button class="format-btn format-toggle" data-cmd="italic" id="btnItalic"><i>I</i></button>
                <button class="format-btn format-toggle" data-cmd="underline" id="btnUnderline"><u>U</u></button>
                <button class="format-btn format-toggle" data-cmd="strikeThrough" id="btnStrike">S</button>

                <button class="color-btn" id="highlightBtn" title="Highlight">üñç Highlight</button>
                <button class="color-btn" id="colorBtn" title="Text color">üé® Color</button>
                <input type="color" id="colorPicker" style="display:none">
              </div>

              <div style="margin-left:12px">
                <div class="muted">Selected date: <span id="selectedDate">‚Äî</span></div>
              </div>
            </div>

            <div>
              <button id="prevDay" class="controls-top">Prev</button>
              <button id="nextDay" class="controls-top">Next</button>
            </div>
          </div>

          <div contenteditable="true" id="editor" class="editor" spellcheck="true"></div>

          <div class="bottom-actions">
            <div class="muted" id="statusText">Not saved</div>
            <div class="right-actions">
              <button id="saveBtn" class="btn">üíæ Save</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script type="module">
/* ========= FIREBASE IMPORTS ========= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, collection, getDocs, onSnapshot
} from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

/* ====== YOUR FIREBASE CONFIG (you gave) ====== */
const firebaseConfig = {
  apiKey: "AIzaSyDRpLl01xtSZ7f0ZbId7zFASUJoem4L69s",
  authDomain: "my-secret-diary-9b62c.firebaseapp.com",
  projectId: "my-secret-diary-9b62c",
  storageBucket: "my-secret-diary-9b62c.firebasestorage.app",
  messagingSenderId: "139353851381",
  appId: "1:139353851381:web:3050a47540d36a2243ccbc"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ========= DOM ========= */
const loginDiv = document.getElementById('login');
const diaryWrap = document.getElementById('diaryWrap');
const passwordInput = document.getElementById('passwordInput');
const loginBtn = document.getElementById('loginBtn');
const diaryTitle = document.getElementById('diaryTitle');

const calGrid = document.getElementById('calGrid');
const monthLabel = document.getElementById('monthLabel');

const editor = document.getElementById('editor');
const selectedDateLabel = document.getElementById('selectedDate');
const saveBtn = document.getElementById('saveBtn');
const statusText = document.getElementById('statusText');

const btnBold = document.getElementById('btnBold');
const btnItalic = document.getElementById('btnItalic');
const btnUnderline = document.getElementById('btnUnderline');
const btnStrike = document.getElementById('btnStrike');
const highlightBtn = document.getElementById('highlightBtn');
const colorBtn = document.getElementById('colorBtn');
const colorPicker = document.getElementById('colorPicker');

const renameBtnTop = document.getElementById('renameBtnTop');
const changePassBtnTop = document.getElementById('changePassBtnTop');

const prevMonth = document.getElementById('prevMonth');
const nextMonth = document.getElementById('nextMonth');

const prevDay = document.getElementById('prevDay');
const nextDay = document.getElementById('nextDay');

const themeSelect = document.getElementById('themeSelect');
const bgUpload = document.getElementById('bgUpload');
const bgBtn = document.getElementById('bgBtn');

/* ========= SETTINGS & STATE ========= */
const SETTINGS_DOC = doc(db, 'entries', 'settings'); // single doc for settings
let salt_b64 = null;
let verifier_b64 = null;
let diaryName = 'My Secret Diary';
let keyMaterial = null; // CryptoKey derived from password
let aesKey = null; // AES-GCM key used to encrypt/decrypt entries
let viewMonth = new Date();
let selectedDate = indiaDateString(new Date());
let diaryEntriesCache = {}; // local cache of decrypted (in-memory) entries

/* ---------- constants ---------- */
const DEFAULT_PASSWORD = '53458678';
const PBKDF2_ITER = 200_000; // strong iteration count (may run a bit slower on low-end; adjust if too slow)
const KEY_LEN = 256;

/* ========= HELPERS: time in India ========= */
function indiaDateString(d) {
  // returns YYYY-MM-DD in Asia/Kolkata timezone
  const tz = 'Asia/Kolkata';
  const parts = new Intl.DateTimeFormat('en-CA', { timeZone: tz }).formatToParts(d);
  // formatToParts returns year, month, day etc.
  // easiest: get epoch then offset using options
  const iso = new Date(d.toLocaleString('en-US', { timeZone: tz }));
  const y = iso.getFullYear();
  const m = String(iso.getMonth() + 1).padStart(2,'0');
  const dd = String(iso.getDate()).padStart(2,'0');
  return `${y}-${m}-${dd}`;
}

function indiaNow() {
  return new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' }));
}

/* ========= CRYPTO HELPERS (Web Crypto) ========= */
async function strToArrayBuffer(str){ return new TextEncoder().encode(str); }
function abToB64(buf){ return btoa(String.fromCharCode(...new Uint8Array(buf))); }
function b64ToAb(b64){ const bin = atob(b64); const arr = new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i); return arr.buffer; }

async function deriveKeyFromPassword(password, salt_b64) {
  const salt = salt_b64 ? b64ToAb(salt_b64) : crypto.getRandomValues(new Uint8Array(16)).buffer;
  const pwKey = await crypto.subtle.importKey('raw', new TextEncoder().encode(password), {name:'PBKDF2'}, false, ['deriveBits','deriveKey']);
  const derivedKey = await crypto.subtle.deriveKey(
    {name:'PBKDF2', salt, iterations: PBKDF2_ITER, hash:'SHA-256'},
    pwKey,
    {name:'AES-GCM', length: KEY_LEN},
    true,
    ['encrypt','decrypt']
  );
  // export raw for verifier computation
  const raw = await crypto.subtle.exportKey('raw', derivedKey);
  const verifier = await crypto.subtle.digest('SHA-256', raw);
  return { derivedKey, salt_b64: salt_b64 || abToB64(salt), verifier_b64: abToB64(verifier) };
}

async function encryptText(aesKey, plaintext) {
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const enc = new TextEncoder().encode(plaintext);
  const cipher = await crypto.subtle.encrypt({name:'AES-GCM', iv}, aesKey, enc);
  return { cipher_b64: abToB64(cipher), iv_b64: abToB64(iv) };
}

async function decryptText(aesKey, cipher_b64, iv_b64) {
  try{
    const cipher = b64ToAb(cipher_b64);
    const iv = b64ToAb(iv_b64);
    const plainBuf = await crypto.subtle.decrypt({name:'AES-GCM', iv:new Uint8Array(iv)}, aesKey, cipher);
    return new TextDecoder().decode(plainBuf);
  } catch(e){
    console.error('decrypt failed', e);
    throw new Error('Decryption failed (wrong password?)');
  }
}

/* ========= FIRESTORE HANDLERS ========= */
async function ensureSettings() {
  const sDoc = await getDoc(SETTINGS_DOC);
  if(sDoc.exists()){
    const d = sDoc.data();
    salt_b64 = d.salt;
    verifier_b64 = d.verifier;
    diaryName = d.name || diaryName;
    diaryTitle.textContent = diaryName;
  } else {
    // first-time create settings with default password
    const { derivedKey, salt_b64: newSalt, verifier_b64: newVer } = await deriveKeyFromPassword(DEFAULT_PASSWORD, null);
    salt_b64 = newSalt; verifier_b64 = newVer;
    // store salt & verifier only (no plaintext password)
    await setDoc(SETTINGS_DOC, { salt: salt_b64, verifier: verifier_b64, name: diaryName });
  }
}

/* load all entries metadata and put into cache (we'll keep ciphertext in db) */
async function loadAllEntriesCache() {
  diaryEntriesCache = {}; // reset
  // get all docs in entries collection except settings
  const colRef = collection(db, 'entries');
  const snap = await getDocs(colRef);
  snap.forEach(d => {
    if (d.id === 'settings') return;
    diaryEntriesCache[d.id] = d.data(); // encrypted blob: {cipher, iv, lastModified}
  });
}

/* Save single encrypted entry */
async function saveEncryptedEntry(dateStr, plaintext) {
  if(!aesKey) throw new Error('No AES key');
  const enc = await encryptText(aesKey, plaintext);
  const payload = { cipher: enc.cipher_b64, iv: enc.iv_b64, lastModified: new Date().toISOString() };
  await setDoc(doc(db, 'entries', dateStr), payload);
  diaryEntriesCache[dateStr] = payload;
}

/* Re-encrypt all entries when changing password */
async function reencryptAllEntries(oldKey, newKey) {
  // fetch all entries except settings
  const colRef = collection(db, 'entries');
  const snap = await getDocs(colRef);
  const entries = [];
  snap.forEach(d => { if(d.id !== 'settings') entries.push({ id: d.id, data: d.data() }); });
  // decrypt with oldKey then encrypt with newKey and write
  for(const e of entries){
    let text = '';
    try { text = await decryptText(oldKey, e.data.cipher, e.data.iv); } catch(err){ console.error('skip decrypt failed', e.id); continue; }
    const enc = await encryptText(newKey, text);
    await setDoc(doc(db, 'entries', e.id), { cipher: enc.cipher_b64, iv: enc.iv_b64, lastModified: new Date().toISOString() });
  }
}

/* Update settings doc (salt/verifier/name) */
async function updateSettings(salt_b64_new, verifier_b64_new, nameVal) {
  await setDoc(SETTINGS_DOC, { salt: salt_b64_new, verifier: verifier_b64_new, name: nameVal }, { merge: true });
}

/* ========= UI & App Flow ========= */
await ensureSettings();  // ensure settings exists on first load

// build calendar UI
function buildCalendar() {
  calGrid.innerHTML = '';
  const m = new Date(viewMonth.getFullYear(), viewMonth.getMonth(), 1);
  monthLabel.textContent = m.toLocaleString(undefined,{month:'long', year:'numeric', timeZone:'Asia/Kolkata'});
  const startDay = m.getDay();
  const days = new Date(m.getFullYear(), m.getMonth()+1, 0).getDate();
  for(let i=0;i<startDay;i++) calGrid.appendChild(document.createElement('div'));
  for(let d=1; d<=days; d++){
    const dateObj = new Date(m.getFullYear(), m.getMonth(), d);
    const dateStr = indiaDateString(dateObj);
    const box = document.createElement('div');
    box.className='date';
    if(dateStr === indiaDateString(new Date())) box.classList.add('today');
    const num = document.createElement('div'); num.className='num'; num.textContent = d;
    box.appendChild(num);
    // preview if entry exists (we only have ciphertext; show a marker if exists)
    if(diaryEntriesCache[dateStr] && diaryEntriesCache[dateStr].cipher) {
      box.classList.add('has');
      // can't preview ciphertext (we don't show decrypted preview) ‚Äî show small dot
      const dot = document.createElement('div'); dot.className='muted'; dot.textContent = '‚óè saved';
      dot.style.fontSize='12px'; dot.style.color='var(--muted)'; dot.style.marginTop='6px';
      box.appendChild(dot);
    }
    box.addEventListener('click', ()=>{ openDate(dateStr); });
    calGrid.appendChild(box);
  }
}

/* Open a date in editor */
async function openDate(dateStr) {
  selectedDate = dateStr;
  selectedDateLabel.textContent = selectedDate;
  // allow editing only if selectedDate <= today in India
  const todayStr = indiaDateString(indiaNow());
  if(selectedDate > todayStr){
    editor.innerHTML = '<div style="color:var(--muted)">Future entries are read-only. You can view only.</div>';
    saveBtn.classList.add('disabled');
  } else {
    // load encrypted doc then decrypt
    const d = await getDoc(doc(db, 'entries', dateStr));
    if(d.exists() && d.data().cipher){
      try {
        const plaintext = await decryptText(aesKey, d.data().cipher, d.data().iv);
        editor.innerHTML = plaintext;
      } catch(e){
        alert('Unable to decrypt entry ‚Äî wrong password?');
        editor.innerHTML = '';
      }
    } else {
      editor.innerHTML = '';
    }
    saveBtn.classList.remove('disabled');
  }
  refreshFormattingButtons();
}

/* Save current editor content */
async function doSave(){
  if(saveBtn.classList.contains('disabled')) return;
  const todayStr = indiaDateString(indiaNow());
  if(selectedDate > todayStr){ alert('Cannot save future entries'); return; }
  const content = editor.innerHTML;
  try{
    await saveEncryptedEntry(selectedDate, content);
    statusText.textContent = 'Saved: ' + new Date().toLocaleString('en-IN', { timeZone:'Asia/Kolkata' });
  } catch(e){
    alert('Save failed: '+e.message);
  }
  buildCalendar();
}

/* LOGIN flow ‚Äî keep UI same */
loginBtn.addEventListener('click', async ()=>{
  const pass = passwordInput.value || '';
  try{
    // derive key from provided password and stored salt
    const { derivedKey, verifier_b64: vcalc } = await deriveKeyFromPassword(pass, salt_b64);
    // compare verifier
    if(vcalc !== verifier_b64){
      alert('Wrong password');
      return;
    }
    // success: store aesKey for decrypt/encrypt use
    aesKey = derivedKey;
    keyMaterial = pass;
    diaryName = (await getDoc(SETTINGS_DOC)).data().name || diaryName;
    diaryTitle.textContent = diaryName;
    // show diary
    loginDiv.style.display = 'none';
    diaryWrap.style.display = 'block';
    // load existing entries list
    await loadAllEntriesCache();
    buildCalendar();
    // open today
    selectedDate = indiaDateString(indiaNow());
    await openDate(selectedDate);
  } catch(err){
    console.error(err);
    alert('Login failed: '+ (err.message || err));
  }
});

/* Formatting buttons & color picker */
function execFormat(cmd, value=null){
  document.execCommand(cmd, false, value);
  refreshFormattingButtons();
}

btnBold.addEventListener('click', ()=>execFormat('bold'));
btnItalic.addEventListener('click', ()=>execFormat('italic'));
btnUnderline.addEventListener('click', ()=>execFormat('underline'));
btnStrike.addEventListener('click', ()=>execFormat('strikeThrough'));

highlightBtn.addEventListener('click', ()=>{
  // highlight: toggle background color selection; use yellow by default
  colorPicker.value = '#fff176'; // soft yellow
  colorPicker.click();
  colorPicker.oninput = () => { execFormat('hiliteColor', colorPicker.value); };
});

colorBtn.addEventListener('click', ()=>{
  colorPicker.click();
  colorPicker.oninput = () => { execFormat('foreColor', colorPicker.value); };
});

/* Make format buttons reflect selection via queryCommandState */
function refreshFormattingButtons(){
  [ {el:btnBold, cmd:'bold'}, {el:btnItalic, cmd:'italic'}, {el:btnUnderline, cmd:'underline'}, {el:btnStrike, cmd:'strikeThrough'} ].forEach(o=>{
    try {
      if(document.queryCommandState(o.cmd)) o.el.classList.add('active'); else o.el.classList.remove('active');
    } catch(e){ /* ignore */ }
  });
}

/* update active while typing/selection changes */
editor.addEventListener('keyup', refreshFormattingButtons);
editor.addEventListener('mouseup', refreshFormattingButtons);

/* Save button */
saveBtn.addEventListener('click', doSave);

/* Prev/Next Month and Day */
prevMonth.addEventListener('click', ()=>{ viewMonth.setMonth(viewMonth.getMonth()-1); buildCalendar(); });
nextMonth.addEventListener('click', ()=>{ viewMonth.setMonth(viewMonth.getMonth()+1); buildCalendar(); });
prevDay.addEventListener('click', async ()=>{ const d = new Date(selectedDate); d.setDate(d.getDate()-1); const s = indiaDateString(d); await openDate(s); });
nextDay.addEventListener('click', async ()=>{ const d = new Date(selectedDate); d.setDate(d.getDate()+1); const s = indiaDateString(d); await openDate(s); });

/* Rename & Change Password behavior (top-right big buttons) */
renameBtnTop.addEventListener('click', async ()=>{
  const newName = prompt('Enter new diary name:', diaryName);
  if(newName === null) return;
  diaryName = newName.trim() || diaryName;
  diaryTitle.textContent = diaryName;
  await updateSettings(salt_b64, verifier_b64, diaryName);
  alert('Diary renamed to: ' + diaryName);
});

changePassBtnTop.addEventListener('click', async ()=>{
  const cur = prompt('Enter current password to confirm:');
  if(cur === null) return;
  // verify
  const { verifier_b64: vcalc } = await deriveKeyFromPassword(cur, salt_b64);
  if(vcalc !== verifier_b64){ alert('Current password incorrect'); return; }
  const newPass = prompt('Enter NEW password:');
  if(!newPass || newPass.trim()===''){ alert('Password change cancelled'); return; }
  // derive new key (create new salt)
  const { derivedKey: newDerived, salt_b64: newSalt, verifier_b64: newVer } = await deriveKeyFromPassword(newPass, null);
  // re-encrypt all entries with new key
  try{
    // create old key for decrypt
    const { derivedKey: oldDerived } = await deriveKeyFromPassword(cur, salt_b64);
    await reencryptAllEntries(oldDerived, newDerived);
    salt_b64 = newSalt; verifier_b64 = newVer; aesKey = newDerived;
    await updateSettings(salt_b64, verifier_b64, diaryName);
    alert('Password changed successfully.');
  } catch(e){
    console.error(e);
    alert('Password change failed: '+e.message);
  }
});

/* Background upload */
bgUpload.addEventListener('change', (ev)=>{
  const f = ev.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = (e)=> {
    document.body.style.backgroundImage = `url('${e.target.result}')`;
    document.body.style.backgroundSize = 'cover';
    document.body.style.backgroundPosition = 'center';
  };
  reader.readAsDataURL(f);
});

/* Theme switch */
themeSelect.addEventListener('change', (ev)=>{
  if(ev.target.value === 'dark'){
    document.documentElement.style.setProperty('--bg-light','#0f1724');
    document.documentElement.style.setProperty('--card','#0b1220');
    document.documentElement.style.setProperty('--paper','#071023');
    document.documentElement.style.setProperty('--muted','#9aa3b2');
    document.documentElement.style.setProperty('--accent','#60a5fa');
    document.documentElement.style.setProperty('--accent-active','#3b82f6');
    document.body.style.color = '#e6eefc';
  } else {
    // reset to light
    document.documentElement.style.setProperty('--bg-light','#f6f9fc');
    document.documentElement.style.setProperty('--card','#fffdf8');
    document.documentElement.style.setProperty('--paper','#fffef6');
    document.documentElement.style.setProperty('--muted','#6b7280');
    document.documentElement.style.setProperty('--accent','#1f6feb');
    document.documentElement.style.setProperty('--accent-active','#0b63d6');
    document.body.style.color = '';
  }
});

/* initial theme */
themeSelect.value = 'light';

/* keyboard Enter to login (keep login screen unchanged) */
passwordInput.addEventListener('keyup', (e)=>{ if(e.key==='Enter') loginBtn.click(); });

/* after initial settings loaded, keep small live subscription to refresh available dates (optional) */
(async function initLiveListen(){
  // initial cache built after login; but we also can live-listen to reflect changes from other devices
  // we will not set a permanent onSnapshot before login (security), but after login loadAllEntriesCache() will show data.
})();

/* ensure selectedDate initial */
selectedDateLabel.textContent = selectedDate;

/* on first load, keep login visible (unchanged) */
/* Done */
</script>
</body>
</html>
