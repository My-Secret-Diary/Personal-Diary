<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Secret Diary</title>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Quicksand', sans-serif;
      background-color: #f4f7fb;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    /* Unchanged login UI */
    #login, #diary {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      padding: 30px;
      width: 360px;
      max-width: 90%;
    }
    h1 {
      text-align: center;
      color: #333;
    }
    input, textarea, button, select {
      width: 100%;
      margin-top: 10px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      outline: none;
      font-size: 15px;
      font-family: inherit;
    }
    button {
      background-color: #4a90e2;
      color: white;
      border: none;
      cursor: pointer;
      transition: 0.2s;
    }
    button:hover { background-color: #357abd; }

    /* Diary full layout */
    #app {
      display: none;
      width: 100%;
      height: 100vh;
      background-size: cover;
      background-position: center;
    }
    #app.dark {
      background-color: #1e1e1e;
      color: white;
    }
    #sidebar {
      width: 25%;
      background: rgba(255,255,255,0.9);
      padding: 20px;
      box-sizing: border-box;
      overflow-y: auto;
    }
    #editorArea {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 20px;
    }
    #toolbar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    #toolbar button {
      width: 36px;
      height: 36px;
      background: #f0f0f0;
      border-radius: 8px;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: 0.2s;
    }
    #toolbar button.active {
      background: #4a90e2;
      color: white;
    }
    #toolbar svg {
      width: 18px;
      height: 18px;
      pointer-events: none;
    }
    #entry {
      flex: 1;
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #ccc;
      background: white;
      overflow-y: auto;
    }
    #saveBtn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #4a90e2;
      color: white;
      border: none;
      border-radius: 50%;
      width: 56px;
      height: 56px;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    #topRight {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      gap: 10px;
    }
    #datePicker {
      width: 100%;
      font-size: 16px;
    }
    #colorInput {
      width: 40px;
      height: 36px;
      padding: 0;
      border: none;
      cursor: pointer;
      background: none;
    }
  </style>
</head>
<body>
  <!-- LOGIN SCREEN (unchanged) -->
  <div id="login">
    <h1>üîí My Secret Diary</h1>
    <p>Enter your diary password</p>
    <input type="password" id="passwordInput" placeholder="Password">
    <button id="loginBtn">Login</button>
  </div>

  <!-- APP MAIN SCREEN -->
  <div id="app">
    <div id="sidebar">
      <input type="date" id="datePicker">
    </div>
    <div id="editorArea">
      <div id="topRight">
        <button id="renameBtn">‚úèÔ∏è Rename</button>
        <button id="changePassBtn">üîë Change</button>
        <button id="themeToggle">üåó</button>
        <input type="file" id="bgUpload" accept="image/*" style="display:none;">
        <button id="bgBtn">üñºÔ∏è</button>
      </div>
      <div id="toolbar">
        <button id="boldBtn" title="Bold"><svg viewBox="0 0 24 24"><path d="M15.6 10.79A4.978 4.978 0 0 0 17 7c0-2.76-2.24-5-5-5H7v18h6a5 5 0 0 0 2.6-9.21z"/></svg></button>
        <button id="italicBtn" title="Italic"><svg viewBox="0 0 24 24"><path d="M10 4v3h2.21l-3.42 10H6v3h8v-3h-2.21l3.42-10H18V4z"/></svg></button>
        <button id="underlineBtn" title="Underline"><svg viewBox="0 0 24 24"><path d="M12 17a5 5 0 0 0 5-5V4h-2v8a3 3 0 0 1-6 0V4H7v8a5 5 0 0 0 5 5zm-7 2v2h14v-2H5z"/></svg></button>
        <button id="highlightBtn" title="Highlight"><svg viewBox="0 0 24 24"><path d="M3 17v2h6l7-7-2-2-7 7H3zm14.85-9.85l-1.79-1.79-1.41 1.41 1.79 1.79 1.41-1.41z"/></svg></button>
        <input type="color" id="colorInput" title="Text color">
        <select id="fontSize">
          <option value="3">Normal</option>
          <option value="4">Large</option>
          <option value="5">Huge</option>
        </select>
        <select id="fontFamily">
          <option value="Quicksand">Quicksand</option>
          <option value="Arial">Arial</option>
          <option value="Times New Roman">Times New Roman</option>
          <option value="Courier New">Courier New</option>
        </select>
      </div>
      <div id="entry" contenteditable="true"></div>
    </div>
    <button id="saveBtn">üíæ</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDRpLl01xtSZ7f0ZbId7zFASUJoem4L69s",
      authDomain: "my-secret-diary-9b62c.firebaseapp.com",
      projectId: "my-secret-diary-9b62c",
      storageBucket: "my-secret-diary-9b62c.firebasestorage.app",
      messagingSenderId: "139353851381",
      appId: "1:139353851381:web:3050a47540d36a2243ccbc"
    };
    const appFB = initializeApp(firebaseConfig);
    const db = getFirestore(appFB);

    const loginDiv = document.getElementById("login");
    const appDiv = document.getElementById("app");
    const passwordInput = document.getElementById("passwordInput");
    const loginBtn = document.getElementById("loginBtn");
    const datePicker = document.getElementById("datePicker");
    const entry = document.getElementById("entry");
    const saveBtn = document.getElementById("saveBtn");
    const boldBtn = document.getElementById("boldBtn");
    const italicBtn = document.getElementById("italicBtn");
    const underlineBtn = document.getElementById("underlineBtn");
    const highlightBtn = document.getElementById("highlightBtn");
    const colorInput = document.getElementById("colorInput");
    const fontSize = document.getElementById("fontSize");
    const fontFamily = document.getElementById("fontFamily");
    const renameBtn = document.getElementById("renameBtn");
    const changePassBtn = document.getElementById("changePassBtn");
    const themeToggle = document.getElementById("themeToggle");
    const bgBtn = document.getElementById("bgBtn");
    const bgUpload = document.getElementById("bgUpload");

    let diaryName = "My Secret Diary";
    let currentPassword = "53458678";
    let encryptionKey;
    let dark = false;

    // Encryption helpers
    async function getKey(pass) {
      const enc = new TextEncoder();
      const keyMaterial = await crypto.subtle.importKey(
        "raw", enc.encode(pass), "PBKDF2", false, ["deriveKey"]
      );
      return crypto.subtle.deriveKey(
        { name: "PBKDF2", salt: enc.encode("mydiary"), iterations: 100000, hash: "SHA-256" },
        keyMaterial, { name: "AES-GCM", length: 256 }, false, ["encrypt","decrypt"]
      );
    }
    async function encrypt(text) {
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const enc = new TextEncoder();
      const data = enc.encode(text);
      const buf = await crypto.subtle.encrypt({name:"AES-GCM", iv}, encryptionKey, data);
      return btoa(JSON.stringify({iv:Array.from(iv),data:Array.from(new Uint8Array(buf))}));
    }
    async function decrypt(encStr) {
      try {
        const {iv,data} = JSON.parse(atob(encStr));
        const buf = new Uint8Array(data);
        const plain = await crypto.subtle.decrypt({name:"AES-GCM", iv:new Uint8Array(iv)}, encryptionKey, buf);
        return new TextDecoder().decode(plain);
      } catch { return ""; }
    }

    loginBtn.onclick = async () => {
      const pass = passwordInput.value.trim();
      if (!pass) return alert("Enter password");
      currentPassword = pass;
      encryptionKey = await getKey(pass);
      loginDiv.style.display = "none";
      appDiv.style.display = "flex";
      datePicker.valueAsDate = new Date();
      await loadEntry();
    };

    async function loadEntry() {
      const date = datePicker.value;
      const docRef = doc(db, "entries", date);
      const snap = await getDoc(docRef);
      if (snap.exists()) {
        const data = snap.data();
        entry.innerHTML = await decrypt(data.text || "");
        if (data.bg) appDiv.style.backgroundImage = `url(${await decrypt(data.bg)})`;
        if (data.theme === "dark") { dark=true; appDiv.classList.add("dark"); }
      } else entry.innerHTML = "";
    }

    saveBtn.onclick = async () => {
      const date = datePicker.value;
      const encText = await encrypt(entry.innerHTML);
      const encBg = appDiv.style.backgroundImage ? await encrypt(appDiv.style.backgroundImage) : "";
      await setDoc(doc(db, "entries", date), { text: encText, bg: encBg, theme: dark?"dark":"light" });
      alert("Saved!");
    };

    datePicker.onchange = loadEntry;

    // Toolbar
    const exec = (cmd, val=null) => document.execCommand(cmd,false,val);
    boldBtn.onclick = () => { exec("bold"); boldBtn.classList.toggle("active"); };
    italicBtn.onclick = () => { exec("italic"); italicBtn.classList.toggle("active"); };
    underlineBtn.onclick = () => { exec("underline"); underlineBtn.classList.toggle("active"); };
    highlightBtn.onclick = () => { exec("backColor","#ffff00"); };
    colorInput.onchange = () => exec("foreColor", colorInput.value);
    fontSize.onchange = () => exec("fontSize", fontSize.value);
    fontFamily.onchange = () => exec("fontName", fontFamily.value);

    // Theme toggle
    themeToggle.onclick = () => {
      dark = !dark;
      appDiv.classList.toggle("dark");
    };

    // Background upload
    bgBtn.onclick = () => bgUpload.click();
    bgUpload.onchange = (e)=>{
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev=>{
        appDiv.style.backgroundImage = `url(${ev.target.result})`;
      };
      reader.readAsDataURL(file);
    };
  </script>
</body>
</html>
